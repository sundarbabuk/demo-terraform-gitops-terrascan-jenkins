// Jenkinsfile

// String credentialsId = 'skAWSCredentials'

pipeline {
  agent any
  environment {
    AWS_DEFAULT_REGION="us-east-1"
    AWS_ACCESS_KEY_ID=skAWSCredentials("AWS_ACCESS_KEY_ID")
    AWS_SECRET_ACCESS_KEY=skAWSCredentials("AWS_SECRET_ACCESS_KEY")
  }

    stages {
        stage('checkout') {
          steps {
            cleanWs()
            checkout scm
          }
        }


    
      // Run terraform init
      stage('init') {
        steps {
          
              sh '/var/jenkins_home/terraform init'
            }
          }
      

  // Run Driftctl
  stage('Validate') {
      failFast true
      parallel {
          stage("driftctl") {
              steps {
                  sh "which dctlenv || git clone https://github.com/wbeuil/dctlenv"
                  sh "dctlenv use latest"
                  sh "/var/jenkins_home/driftctl scan"
              }
          }
          stage("terraform/fmt") {
              steps {
                  sh "/var/jenkins_home/terraform fmt -check -diff"
              }
          }
          stage("terraform/validate") {
              steps {
                  sh "/var/jenkins_home/terraform validate"
              }
            }
          }
        }


  // Run terraform plan
  stage('plan') {
    node {
      withCredentials([[
        $class: 'AmazonWebServicesCredentialsBinding',
        credentialsId: credentialsId,
        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
      ]]) {
        ansiColor('xterm') {
          sh '/var/jenkins_home/terraform plan'
        }
      }
    }
  }

  if (env.BRANCH_NAME == 'main') {

    // Run terraform apply
    stage('apply') {
      node {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: credentialsId,
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          ansiColor('xterm') {
            sh '/var/jenkins_home/terraform apply -auto-approve'
          }
        }
      }
    }

    // Run terraform show
    stage('show') {
      node {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: credentialsId,
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          ansiColor('xterm') {
            sh '/var/jenkins_home/terraform show'
          }
        }
      }
    }
  }
  currentBuild.result = 'SUCCESS'
  }
}